/*
test-curve25519 version 20050915
D. J. Bernstein
Public domain.

 - modified to be self-verifying up to 2^28 rounds, results generated with djb's 64bit fp 
   'reference' implementation

 - requires openssl
*/

#include <stdio.h>
#include <memory.h>
#include <openssl/md5.h>

extern int curve25519_donna(unsigned char *output, const unsigned char *a, const unsigned char *b);
extern void curve25519_donna_raw(unsigned char *output, const unsigned char *a, const unsigned char *b);

static MD5_CTX ctx;

static char *hashresults[] = {
  "\x57\xfd\xf3\x27\xce\xea\x4e\x9f\x5a\xb7\xff\xb8\x76\x18\xd1\x42",
  "\xc6\x01\x2b\xf4\x01\xc0\xf2\x77\xc5\xba\x74\xd1\x45\x06\x74\x39",
  "\xe8\x6d\xa6\x90\x8b\xe1\xf4\x46\x26\x8b\x5f\xa7\x9f\xaf\xdc\xa1",
  "\x5f\x67\x30\xfa\x8c\x99\x70\x29\xe1\x40\x25\xe9\xfa\xfb\x23\xf4",
  "\x8e\xc8\x96\x1b\xf5\x4e\x36\x6f\x4e\x10\xcb\xef\xd2\xdb\xd1\x04",
  "\x4d\x0b\x0a\xff\x25\xce\xd1\x8e\x18\x76\xe5\x83\x64\xea\xa9\x32",
  "\x2e\x34\xf9\xfe\x44\x29\x8e\xf7\x93\x27\x6f\x81\x93\x2c\x31\x1c",
  "\x64\x7c\x44\x3f\xb8\x6d\xe2\x9d\x23\x19\xa5\x1f\xb4\xee\x73\x3f",
  "\x17\x8b\xf1\x19\xac\x59\x3d\xe6\x97\xec\x5a\x3c\x88\x3c\xba\x7a",
  "\x41\x81\xdd\xf4\x91\x9d\x71\x9e\x26\xbd\x4e\x33\x15\x03\x78\xbd",
  "\x84\xa4\x98\xd7\x89\x67\xca\x7e\xbc\x50\xd7\x77\xfa\x70\xe7\xc2",
  "\x2f\x90\xba\x0d\xe8\x76\x42\x0e\xe4\xb3\xf3\xfb\x2c\xf1\xbf\xe4",
  "\xd0\xb6\x05\xd4\xc5\x5e\xf8\xad\x42\x4e\x6c\x54\xb5\x03\x52\x3a",
  "\x5b\x57\x44\xa2\x8d\xaf\x16\xa3\x6f\xbb\x20\xbb\x7c\x0b\x68\x27",
  "\xea\xa4\x60\x63\xac\x9d\xfb\x58\x53\x0f\x88\x91\xa9\x6a\xd9\xab",
  "\x7c\x30\x87\xc0\xb9\xbc\x73\x99\x9c\x55\xe3\x88\x7d\xcf\xd6\x8b",
  "\x84\x7f\x27\x90\xf7\x87\xe1\xf6\x1d\x22\x06\x09\x28\xc2\x16\x92",
  "\x87\x1c\xb7\x49\xb8\x75\xb0\xf7\x21\x90\x8b\x79\xc2\xf3\x8b\xa0",
  "\xc3\x59\xac\xb7\x5a\x7d\x1a\x70\x79\x12\xf7\x5e\xee\xfa\x17\xc0",
  "\x1d\x39\x8c\x97\x98\x13\x65\x52\xcb\xc0\x11\x88\x86\x22\x47\x48",
  "\xc7\x00\xcf\xda\xd7\x2e\xd9\xa9\x1c\x40\x04\x02\x11\xdd\x88\x02",
  "\x06\x60\x9b\x69\xe2\x23\x71\xfa\xae\xc9\x76\xec\x32\x6f\x16\x49",
  "\x0c\x17\x28\x45\x9f\xc7\xba\x7b\xa3\x6c\xc4\x55\x59\xc1\xff\x03",
  "\x8c\x7f\x61\x71\xd8\xc5\xc3\xe4\x42\x1c\x6c\x5f\xba\x6e\x09\x06",
  "\x33\x5d\xa0\xee\x3d\xc4\xc6\x89\x8d\xff\xe7\xcc\xd1\xb1\xf5\x9c",
  "\x0c\xf4\x83\xe5\xe8\xf8\xe4\x45\x51\xfa\x47\xcb\x49\x57\xe4\x2c",
  "\xd8\x4b\xc0\xc2\xcc\xc4\x89\x8d\x2a\xa1\x98\xf0\x81\x9d\x2d\xc0",
  "\x58\xa2\xca\xcf\x14\xa8\xe5\xae\x56\x6d\xf9\xd5\x65\xd2\x1b\x76",
  "\x14\xeb\xb9\xcf\xa5\xa4\x23\x19\x49\x13\xfd\x02\xcc\xe3\x94\x6d",
  /* "\x80\xf6\xca\x78\x53\xf1\x2e\x82\xa8\xb9\x8a\x5d\x13\x2f\x68\x36" 536870912 iterations, generated by c64 impl, not djb's ref impl */
  NULL,
};

static int result = 0;

static void
dump(int loop) {
  MD5_CTX t;
  unsigned char hash[16];
  int i;
  memcpy(&t, &ctx, sizeof(MD5_CTX));
  MD5_Final(hash, &t); 
  printf(" %s ", hashresults[result] ? ((memcmp(hash, hashresults[result++], sizeof(hash)) == 0) ? "OK  " : "FAIL") : "    ");
  for (i = 0;i < sizeof(hash);++i) printf("%02x",(unsigned int) hash[i]);
  printf(" %u", loop);
  printf("\n");
}

static void
doit(unsigned char *ek,unsigned char *e,unsigned char *k) {
  curve25519_donna_raw(ek,e,k);
  MD5_Update(&ctx, e, 32);
  MD5_Update(&ctx, k, 32);
  MD5_Update(&ctx, ek, 32);
}

unsigned char e1k[32];
unsigned char e2k[32];
unsigned char e1e2k[32];
unsigned char e2e1k[32];
unsigned char e1[32] = {3};
unsigned char e2[32] = {5};
unsigned char k[32] = {9};

int
main() {
  int loop;
  int i;
  int pow = 1;

  MD5_Init(&ctx);
  for (loop = 0;loop < 1000000000;++loop) {
    doit(e1k,e1,k);
    doit(e2e1k,e2,e1k);
    doit(e2k,e2,k);
    doit(e1e2k,e1,e2k);
    for (i = 0;i < 32;++i) if (e1e2k[i] != e2e1k[i]) {
      printf("fail\n");
      return 1;
    }
    for (i = 0;i < 32;++i) e1[i] ^= e2k[i];
    for (i = 0;i < 32;++i) e2[i] ^= e1k[i];
    for (i = 0;i < 32;++i) k[i] ^= e1e2k[i];
    if (loop == pow) {
      pow <<= 1;
      dump(loop);
    }
  }

  return 0;
}
